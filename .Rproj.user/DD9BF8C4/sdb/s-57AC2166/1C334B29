{
    "collab_server" : "",
    "contents" : "rm(list=ls())\ngc()\nlibrary(magrittr)\nlibrary(ggpubr)\nlibrary(data.table)\nlibrary(COVID19)\nlibrary(zoo)\nlibrary(mgcv)\nlibrary(EpiEstim)\nsource('scripts/utils.R')\n\n\n\n\n\n\n\n\n# R_e ---------------------------------------------------------------------\n\n# \n# x <- seird(log(2)/2.6)\n# \n# # https://wwwnc.cdc.gov/eid/article/26/6/20-0357_article SI: mean SI = 3.96, sd=4.75\n# \n# ### following Gostic et al.'s implementation of Cori et al.\n# out <- estimate_R(x$new_confirmed,\n#            method='parametric_si',\n#            config = make_config(\n#              list(\n#                mean_si = 3.96,\n#                std_si = 4.75\n#              )\n#            ))\n# \n# \n# plot(out$dates[8:nrow(x)],log(out$R$`Mean(R)`))\n# lines(x$day[1:(nrow(x)-7)],x$rt[1:(nrow(x)-7)])\n# out$R %>%\n#   mutate(time = if(wend == TRUE) t_end else ceiling((t_end+t_start)/2) ) %>%\n#   select(time, `Mean(R)`, `Quantile.0.025(R)`, `Quantile.0.975(R)`) %>%\n#   setNames(c('time', paste0(out_name, '.mean'), paste0(out_name, '.025'), paste0(out_name, '.975')))\n\n# transmission rate -------------------------------------------------------\n\nS0=3.27e8\ngrowth_rates=log(2)/c(2,5,10)\nx <- NULL\nfor (r in growth_rates){\n  x <- rbind(x,seird(r,days=400))\n}\n\nx[,doubling_time:=factor(round(log(2)/r))]\n\ng1=ggplot(x,aes(deaths_pc,growth_rate,by=doubling_time,color=doubling_time))+\n  geom_line(lwd=2)+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:1),limits=c(1e-8,0.1))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,1.2*max(x$r)))+\n  ggtitle('Epidemics over Deaths per-capita')+\n  geom_vline(lty=2,xintercept = 0.004)+\n  theme_bw()\n\ng2=ggplot(x,aes(date,new_confirmed/S0,by=doubling_time,color=doubling_time))+\n  geom_line(lwd=2)+\n  scale_y_continuous('Cases per capita')+\n  ggtitle('Epidemics over Time')+\n  theme_bw()\n\nggarrange(g2,g1,nrow=2)\nggsave('figures/epidemics_over_time_and_deaths.png',height=10,width=11,units='in')\n\n\n\n\nggplot(x[date>as.Date('2020-02-01')],aes(date,shift(rt,16),color=doubling_time))+\n  geom_line(lwd=2)+\n  geom_line(aes(date,growth_rate),lwd=2,lty=2,col='black')+\n  facet_wrap(.~doubling_time)+\n  scale_y_continuous(limits=c(-0.3,1))+\n  ggtitle('Suitability of rolling Poisson glm to estimate r(t)')+\n  theme_bw()\nggsave('figures/suitability_of_nbss_estimates_of_rt.png',height=8,width=11,units='in')\n\n\nmx <- x[,list(day=day[which.max(I)],\n              deaths_pc=deaths_pc[which.max(I)],\n              rt=rt[which.max(I)],\n              date=date[which.max(I)]),by=doubling_time]\n\ng_dt=ggplot(x,aes(day,deaths_pc,by=doubling_time,color=doubling_time))+\n  geom_line(lwd=2)+\n  geom_point(data=mx,cex=7,pch=19)\ng_dt_log <- g_dt+scale_y_continuous(trans='log',breaks=10^(-8:0))\nggarrange(g_dt,g_dt_log,nrow=2)+\n  theme_bw()\nggsave('figures/death_time_scaling_with_peak_days.png',height=10,width=11,units='in')\n\n \n# x[,doubling_time:=factor(doubling_time,levels =rev(c(2,3,5,7,10,14)))]\n# g_i=ggplot(x[date>as.Date('2020-02-15') & date<as.Date('2020-11-01')],\n#            aes(date,new_confirmed/S0,by=doubling_time,color=doubling_time))+\n#   geom_line(lwd=2)+\n#   scale_y_continuous('Cases per capita')+\n#   ggtitle('Epidemics over Time')\n# g_rt=ggplot(x[date>as.Date('2020-02-15') & date<as.Date('2020-11-01')],\n#             aes(date,growth_rate,by=doubling_time,color=doubling_time))+\n#   geom_hline(lwd=2,col='black',yintercept = 0)+\n#   geom_line(lwd=2)+\n#   scale_y_continuous('Estimated Exponential Growth Rate, r(t)',limits = c(-1/7,log(2)))+\n#   ggtitle('Growth Rate over Time')\n# \n# \n# \n# ggarrange(g_i,g_rt,nrow=2)\n# \n# \n# x[abs(growth_rate)>1,growth_rate:=NA]\n\n\n\n# NY analysis -------------------------------------------------------------\nUS <- COVID19::covid19(country='United States',level=2) %>% as.data.table\nUS[,state:=administrative_area_level_2]\nNY <- US[state=='New York']\nsetkey(NY,date)\n\nNY[,new_deaths:=c(deaths[1],diff(deaths))]\n\nggplot(NY[date<as.Date('2020-05-01')],aes(date,new_deaths))+\n  geom_point()+\n  scale_y_continuous(trans='log')\n\ngr <- glm(new_deaths~date,family=poisson,data=NY[date>as.Date('2020-03-15') & date<as.Date('2020-04-02')])\n\nNY[,new_confirmed:=c(confirmed[1],diff(confirmed))]\nNY <- nbss(NY)\nNY <- as.data.table(NY)\nNY[,intervention_efficacy:='NY State']\nNY[,deaths_pc:=deaths/population]\n\n# interventions -----------------------------------------------------------\nNY[date>as.Date('2020-03-15') & date<as.Date('2020-04-02'),growth_rate]\n\nS0=19.54e6\n# intervention_efficacies=seq(0,1,by=0.2)\nintervention_efficacies <- c(0,0.25,0.5,0.75,1)\nintervention_deaths=1\ny <- NULL\n\nr <- 0.2585 ## New York value obtained above\nfor (a in intervention_efficacies){\n  y <- rbind(y,seird(r,intervention_efficacy = a,\n                     intervention_deaths = intervention_deaths,days=400,\n                     S0=S0,gamma=1/4))\n}\n\n\ny[,doubling_time:=log(2)/(r*intervention_efficacy)]\ny[,intervention_efficacy:=factor(intervention_efficacy)]\n\nggplot(y,aes(deaths_pc,growth_rate,by=intervention_efficacy,color=intervention_efficacy))+\n  geom_line(lwd=2)+\n  geom_line(aes(deaths_pc,shift(rt,16)),lty=2)+\n  geom_vline(xintercept = intervention_deaths/S0,lwd=2,lty=2)+\n  geom_line(data=NY,aes(deaths_pc,shift(growth_rate,10)),col='black')+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:0),limits=c(1e-6,3e-3))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,0.5))+\n  ggtitle('Early Intervention')+\n  theme_bw()\n\nggsave('figures/nbss_inference_under_instantaneous_intervention.png',height=8,width=11)\n\nggplot(y,aes(deaths_pc,beta,by=intervention_efficacy,color=intervention_efficacy))+\n  geom_line(lwd=2)+\n  geom_vline(xintercept = intervention_deaths/S0)+\n  scale_x_continuous(trans='log')\n\ng_early=ggplot(y,aes(deaths_pc,growth_rate,by=intervention_efficacy,color=intervention_efficacy))+\n  geom_line(lwd=2)+\n  geom_vline(xintercept = intervention_deaths/S0,lwd=2,lty=2)+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:0),limits=c(1e-8,1.1*max(y$deaths_pc)))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,1.2*max(y$r)))+\n  ggtitle('Early Intervention')+\n  theme_bw()\ng_early\n\n\ny <- NULL\nfor (a in intervention_efficacies){\n  y <- rbind(y,seird(r,intervention_efficacy = a,\n                     intervention_deaths = 114,\n                     days=400,S0=S0))\n}\n\n\ny[,intervention_efficacy:=factor(intervention_efficacy)]\n\n\ng_late=ggplot(y,aes(deaths_pc,growth_rate,by=intervention_efficacy,color=intervention_efficacy))+\n  geom_line(lwd=2)+\n  geom_vline(xintercept=114/S0,lty=3,lwd=2)+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:0),limits=c(1e-8,1.1*max(y$deaths_pc)))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,1.2*max(y$r)))+\n  ggtitle('Late Intervention')+\n  theme_bw()\n\n\nggarrange(g_early,g_late,nrow=2)\nggsave('figures/early_vs_late_intervention.png',height=10,width=12,units='in')\n\n\nggarrange(g_early+\n            geom_line(aes(deaths_pc,shift(rt,16)),lty=2),\n          g_late+\n            geom_line(aes(deaths_pc,shift(rt,16)),lty=2),nrow=2)\nggsave('figures/early_vs_late_intervention_w_seir.png',height=10,width=12,units='in')\n\n\n# Relaxation --------------------------------------------------------------\nS0=19.54e6\nintervention_efficacy <- 0.8\nintervention_deaths=1\nrelaxation_deaths=c(2,100,5000)\n\nr=0.2585\ny <- seird(r,days=400,S0=S0)\ny[,relaxation_deaths:=0]\nfor (b in relaxation_deaths){\n  y <- rbind(y,seird(r,intervention_efficacy = intervention_efficacy,\n                     intervention_deaths = intervention_deaths,\n                     relaxation_deaths=b,\n                     days=400,S0=S0))\n}\n\nz <- seird(r,S0=S0,intervention_deaths = 50,intervention_efficacy = 1)\nz$relaxation_deaths <- NULL\nz$relaxation_deaths='Successful Intervention'\n\ny <- rbind(y,z)\n\ny[,relaxation_deaths:=factor(relaxation_deaths)]\nggplot(y,aes(deaths_pc,growth_rate,by=relaxation_deaths,color=relaxation_deaths))+\n  geom_line(data=z,lwd=2,col='black')+\n  geom_line(lwd=2)+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:0),limits=c(1e-8,1.1*max(y$deaths_pc)))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,1.2*max(y$r)))+\n  # geom_line(data=z,col='black',lty=2,lwd=2)+\n  ggtitle('Relaxation of Interventions')+\n  theme_bw()+\n  geom_vline(xintercept = 4e-3)+\n  scale_color_manual(values=c(viridis::viridis(4),'black'),labels=c(0,relaxation_deaths,'Successful Intervention'))\n\nggsave('figures/relaxation_of_interventions_70prc_effective_to_complete_relax.png',height=6,width=11,units='in')\n\n\nggplot(y,aes(deaths_pc,growth_rate,by=relaxation_deaths,color=relaxation_deaths))+\n  geom_line(lwd=2)+\n  # geom_vline(xintercept=intervention_deaths/S0,lty=3,lwd=2)+\n  scale_x_continuous('Deaths per capita',trans='log',breaks=10^(-8:0),limits=c(1e-8,1.1*max(y$deaths_pc)))+\n  scale_y_continuous('Inferred Growth Rate',limits=c(-0.2,1.2*max(y$r)))+\n  # geom_line(data=z,col='black',lty=2,lwd=2)+\n  ggtitle('Relaxation of Interventions')+\n  theme_bw()+\n  # geom_vline(xintercept = 4e-3)+\n  geom_line(aes(deaths_pc,shift(rt,16)),lty=2)+\n  scale_color_manual(values=c(viridis::viridis(4),'black'),labels=c(0,relaxation_deaths,'Successful Intervention'))\nggsave('figures/relaxation_of_interventions_70prc_effective_to_complete_relax_w_seir.png',height=6,width=11,units='in')\n\n",
    "created" : 1598300486540.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3667628008",
    "id" : "1C334B29",
    "lastKnownWriteTime" : 1598471455,
    "last_content_update" : 1598471455244,
    "path" : "~/COVID/covid_r_v_D/scripts/r_v_D_sims.R",
    "project_path" : "scripts/r_v_D_sims.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}