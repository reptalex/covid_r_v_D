{
    "collab_server" : "",
    "contents" : "rm(list=ls())\ngc()\nlibrary(data.table)\nlibrary(magrittr)\nlibrary(ggplot2)\nlibrary(ggpubr)\nlibrary(RColorBrewer)\n\n# # NBSS data import --------------------------------------------------------\n\nUSA <- read.csv('data/nbss_us_states.csv') %>% as.data.table\nUSA[,date:=as.Date(date)]\nsetkey(USA,state,date)\nX <- read.csv('data/nbss_countries.csv') %>% as.data.table\n\nSWE <- X[country=='Sweden']\nswy <- rgb(1,205/255,0)\nSWE[,date:=as.Date(date)]\nUSA[,growth_rate:=shift(growth_rate,10),by=state]\nSWE[,growth_rate:=shift(growth_rate,10)]\n\n# states by confirmed cases -----------------------------------------------\n\nUSA[date>=as.Date('2020-06-01') & date<as.Date('2020-09-01'),\n    list(N=sum(new_confirmed,na.rm=T),D=sum(deaths[.N]-deaths[1])),by=state][order(N,decreasing = T)]\n#                   state      N    D\n# 1:           California 553086 7883\n# 2:              Florida 544408 7919\n# 3:                Texas 513250 9692\n# 4:              Georgia 206963 3058\n# 5:              Arizona 178167 3854\n# 6:       North Carolina 126524 1633\n# 7:            Tennessee 120931 1200\n# 8:            Louisiana 103146 1945\n# 9:             Illinois 101335 2677\n# 10:       South Carolina 100127 2004\n# 11:              Alabama  94210 1367\n# 12:                 Ohio  79289 1772\n# 13:             Virginia  68359 1075\n# 14:          Mississippi  62393 1501\n# 15:             Missouri  59353  653\n# 16:             New York  58967 1329\n# 17:               Nevada  57008  752\n# 18:         Pennsylvania  56502 2011\n# 19:            Wisconsin  54641  494\n# 20:              Indiana  51358 1078\n# 21:             Maryland  51324 1066\n# 22:             Arkansas  49721  554\n# 23:           Washington  47594  739\n# 24:             Oklahoma  46659  392\n# 25:            Minnesota  43262  753\n# 26:             Michigan  43240  816\n# 27:                 Utah  39318  272\n# 28:                 Iowa  36723  485\n# 29:             Kentucky  33825  442\n# 30:           New Jersey  29080 2454\n# 31:             Colorado  28785  634\n# 32:               Kansas  27137  202\n# 33:                Idaho  26823  224\n# 34:          Puerto Rico  26120  254\n# 35:        Massachusetts  24555 1886\n# 36:               Oregon  20694  263\n# 37:             Nebraska  17875  206\n# 38:           New Mexico  16678  387\n# 39:          Connecticut   9330  496\n# 40:             Delaware   7424  129\n# 41:         North Dakota   7299   62\n# 42:        West Virginia   7262  103\n# 43:         South Dakota   6283   99\n# 44:         Rhode Island   6275  315\n# 45:              Montana   5915   73\n# 46:               Hawaii   5705   30\n# 47: District of Columbia   4789  136\n# 48:               Alaska   4723   22\n# 49:              Wyoming   2684   20\n# 50:        New Hampshire   2562  184\n# 51:                Maine   2010   42\n# 52:              Vermont    577    3\n# 53:                 Guam    542    2\n\n\n# State interventions -----------------------------------------------------\n\nintervention_cols <- data.frame('intervention'=c('pre-stay-at-home','stay-at-home',\n                                                 'reopening1','reopening2','masks','reversal'),\n                                'color'=brewer.pal(6,'Paired'))\n\n\nAZ <- USA[state=='Arizona']\nNY <- USA[state=='New York']\nFL <- USA[state=='Florida']\nTX <- USA[state=='Texas']\nMN <- USA[state=='Minnesota']\nCA <- USA[state=='California']\nLA <- USA[state=='Louisiana']\n\n# \n# xx <- covid19(country = 'United States',level=2) %>% as.data.table\n# xx[,state:=administrative_area_level_2]\n# NY <- xx[state=='New York']\n# NY[,new_confirmed:=c(confirmed[1],diff(confirmed))]\n# NY <- nbss(NY,level='SEIR')\n# NY[,deaths_pc:=deaths/population]\n# NY[,growth_rate:=shift(growth_rate,10)]\n\n# Arizona -----------------------------------------------------------------\n\nAZ[date<as.Date('2020-03-30'),intervention:='pre-stay-at-home']\nAZ[date>=as.Date('2020-03-30') & date<as.Date('2020-05-15'),intervention:='stay-at-home']\nAZ[date>=as.Date('2020-05-15') & date<as.Date('2020-06-17'),intervention:='reopening']\nAZ[date>=as.Date('2020-06-17'),intervention:='local mask-wearing mandate']\nAZ[date>as.Date('2020-06-29'),intervention:='reopening_reversal']\nAZ[,intervention:=factor(intervention,levels=unique(intervention))]\n\nlbl <- data.frame('deaths_pc'=c(1e-5,3e-6),\n                  'growth_rate'=c(0.37,0.1),\n                  'label'=c('New York','Sweden'))\n\naz <- ggplot(AZ,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  # geom_line(data=AZ[intervention=='reopening_reversal'],color='red',lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:3,5,6)])+\n  geom_text(data=lbl,aes(label=label,color=NULL))+\n  geom_label(data=lbl,aes(label=label,color=NULL),col=c('black',swy),size=10)+\n  geom_hline(yintercept = 0)+\n  ggtitle('Arizona')\n\naz.rt <- ggplot(AZ[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:3,5,6)])+\n  theme(legend.position='none')+\n  geom_vline(xintercept = AZ[grepl('local',intervention),min(date)])+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\naz.cs <- ggplot(AZ[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[c(1:3,5,6)])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\naz2=az+annotation_custom(ggplotGrob(az.rt),\n                     xmin=log(3e-4),xmax=log(3e-3),\n                     ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(az.cs),\n                    xmin=log(2.8e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n\n# Texas -------------------------------------------------------------------\n\nTX[date<as.Date('2020-03-31'),intervention:='pre-stay-at-home']\nTX[date>=as.Date('2020-03-31') & date<as.Date('2020-05-01'),intervention:='stay-at-home']\nTX[date>=as.Date('2020-05-01') & date<as.Date('2020-05-18'),intervention:='Phase 1']\n# TX[date>=as.Date('2020-05-18') & date<as.Date('2020-06-03'),intervention:='Phase 2']\n# TX[date>=as.Date('2020-06-03') & date<as.Date('2020-06-26'),intervention:='Phase 3']\nTX[date>=as.Date('2020-05-18') & date<as.Date('2020-06-26'),intervention:='Phase 2-3']\nTX[date>=as.Date('2020-06-26'),intervention:='reopening_reversal']\nTX[,intervention:=factor(intervention,levels=unique(intervention))]\n\ntx <- ggplot(TX,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  # geom_line(data=TX[intervention=='reopening_reversal'],color='red',lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:4,6)])+\n  geom_hline(yintercept = 0)+\n  ggtitle('Texas')\n\ntx.rt <- ggplot(TX[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:4,6)])+\n  theme(legend.position='none')+\n  geom_vline(xintercept = TX[grepl('reversal',intervention),min(date)])+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\ntx.cs <- ggplot(TX[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[c(1:4,6)])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\ntx2=tx+annotation_custom(ggplotGrob(tx.rt),\n                        xmin=log(3e-4),xmax=log(3e-3),\n                        ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(tx.cs),\n                    xmin=log(2.65e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n\n# New York ----------------------------------------------------------------\n# NY[date<as.Date('2020-03-23'),intervention:='pre_stay-at-home']\n# NY[date>=as.Date('2020-03-23') & date<as.Date('2020-05-19'),intervention:='stay-at-home']\n# NY[date>=as.Date('2020-05-19') & date<as.Date('2020-06-22'),intervention:='reopening']\n\n# ggplot(NY,aes(deaths_pc,growth_rate,color=intervention))+\n#   geom_line(lwd=2)+\n#   scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n#   scale_y_continuous(limits=c(-0.2,0.6))\n\n# Louisiana ---------------------------------------------------------------\nLA[date<as.Date('2020-03-23'),intervention:='pre-stay-at-home']\nLA[date>=as.Date('2020-03-23') & date<as.Date('2020-05-15'),intervention:='stay-at-home']\nLA[date>=as.Date('2020-05-15') & date<as.Date('2020-06-05'),intervention:='Phase 1']\nLA[date>=as.Date('2020-06-05'),intervention:='Phase 2']\n\nLA[,intervention:=factor(intervention,levels=unique(intervention))]\n\nla <- ggplot(LA,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[1:4])+\n  geom_hline(yintercept = 0)+\n  ggtitle('Louisiana')\n\nla.rt <- ggplot(LA[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[1:4])+\n  theme(legend.position='none')+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\nla.cs <- ggplot(LA[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[1:4])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\nla2 <- la+annotation_custom(ggplotGrob(la.rt),\n                        xmin=log(3e-4),xmax=log(3e-3),\n                        ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(la.cs),\n                    xmin=log(2.8e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n\n# Florida -----------------------------------------------------------------\nFL[date<as.Date('2020-03-30'),intervention:='pre-stay-at-home']\nFL[date>=as.Date('2020-03-30') & date<as.Date('2020-06-01'),intervention:='stay-at-home']\nFL[date>=as.Date('2020-06-01'),intervention:='reopening']\nFL[,intervention:=factor(intervention,levels=unique(intervention))]\nfl <- ggplot(FL,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1,2,4)])+\n  geom_hline(yintercept = 0)+\n  ggtitle(\"Florida\")\n\nfl.rt <- ggplot(FL[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1,2,4)])+\n  theme(legend.position='none')+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\nfl.cs <- ggplot(FL[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[c(1,2,4)])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\nfl2=fl+annotation_custom(ggplotGrob(fl.rt),\n                        xmin=log(3e-4),xmax=log(3e-3),\n                        ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(fl.cs),\n                    xmin=log(2.6e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n\n# Minnesota ---------------------------------------------------------------\nMN[date<as.Date('2020-03-27'),intervention:='pre-stay-at-home']\nMN[date>=as.Date('2020-03-27') & date<as.Date('2020-05-18'),intervention:='stay-at-home']\nMN[date>=as.Date('2020-05-18'),intervention:='reopening']\nMN[,intervention:=factor(intervention,levels=unique(intervention))]\n\nmn <-  ggplot(MN,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1,2,4)])+\n  geom_hline(yintercept = 0)+\n  ggtitle('Minnesota')\n\nmn.rt <- ggplot(MN[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1,2,4)])+\n  theme(legend.position='none')+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\nmn.cs <- ggplot(MN[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[c(1,2,4)])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\nmn2=mn+annotation_custom(ggplotGrob(mn.rt),\n                        xmin=log(3e-4),xmax=log(3e-3),\n                        ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(mn.cs),\n                    xmin=log(2.8e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n\n# California --------------------------------------------------------------\nCA[date<as.Date('2020-03-19'),intervention:='pre-stay-at-home']\nCA[date>=as.Date('2020-03-19') & date<as.Date('2020-05-07'),intervention:='stay-at-home']\nCA[date>=as.Date('2020-05-07') & date<as.Date('2020-06-07'),intervention:='Stage 2']\nCA[date>=as.Date('2020-06-07') & date<as.Date('2020-06-28'),intervention:='Stage 3']\nCA[date>=as.Date('2020-06-28'),intervention:='reopening_reversal']\nCA[,intervention:=factor(intervention,levels=unique(intervention))]\n\nca <-  ggplot(CA,aes(deaths_pc,growth_rate,color=intervention))+\n  geom_line(col='black')+\n  geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n  geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n  geom_line(lwd=2)+\n  # geom_line(data=CA[intervention=='reopening_reversal'],color='red',lwd=2)+\n  scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:4,6)])+\n  geom_hline(yintercept = 0)+\n  ggtitle('California')\n\nca.rt <- ggplot(CA[date>as.Date('2020-03-01')],\n                aes(date,growth_rate,color=intervention))+\n  geom_line(lwd=2)+\n  geom_point(cex=2)+\n  theme_bw()+\n  scale_color_manual(values=intervention_cols$color[c(1:4,6)])+\n  theme(legend.position='none')+\n  geom_vline(xintercept = CA[grepl('reversal',intervention),min(date)])+\n  scale_y_continuous('r(t)')+  \n  scale_x_continuous(limits = as.Date(c('2020-03-01','2020-09-01')),\n                     breaks=as.Date(c('2020-03-01','2020-05-01','2020-07-01','2020-09-01')),\n                     labels = c('Mar','May','July','Sep'))\n\nca.cs <- ggplot(CA[date>as.Date('2020-03-01')],\n                aes(date,new_confirmed,fill=intervention))+\n  geom_bar(stat='identity')+\n  theme_bw()+\n  scale_fill_manual(values=intervention_cols$color[c(1:4,6)])+\n  theme(legend.position='none')+\n  scale_y_continuous('N(t)')+\n  scale_x_continuous(name=NULL,breaks=NULL)\n\nca2=ca+annotation_custom(ggplotGrob(ca.rt),\n                        xmin=log(3e-4),xmax=log(3e-3),\n                        ymin=0.07,ymax=0.25)+\n  annotation_custom(ggplotGrob(ca.cs),\n                    xmin=log(2.65e-4),xmax=log(3e-3),\n                    ymin=0.25,ymax=0.4)\n\n# all ---------------------------------------------------------------------\n\n\n\nggarrange(az2,ca2,fl2,tx2,mn2,la2,nrow=3,ncol=2,align='v')\nggsave('figures/state_intervention_trajectories.png',height=15,width=20)\n\n# ggsave('figures/state_intervention_trajectories.png',height=12,width=15)\n\n\nplot_state <- function(st,SWE.=SWE,NY.=NY){\n  lbl <- rbind(lbl,data.frame('deaths_pc'=1e-5,'growth_rate'=0.23,'label'=st))\n  USA[state==st] %>%\n    ggplot(aes(deaths_pc,growth_rate))+\n    geom_line(data=NY,aes(color='black'),color='black',lwd=2)+\n    geom_line(data=SWE,aes(color='black'),color=swy,lwd=2)+\n    geom_line(lwd=2,col='steelblue')+\n    scale_x_continuous(trans='log',limits=c(1e-6,3e-3),breaks=10^(-6:0))+\n    scale_y_continuous(limits=c(-0.1,0.4))+\n    theme_bw()+\n    geom_text(data=lbl,aes(label=label,color=NULL))+\n    geom_label(data=lbl,aes(label=label,color=NULL),col=c('black',swy,'steelblue'),size=10)+\n    geom_hline(yintercept = 0)+\n    ggtitle(st) %>% \n      return\n}\nplot_state('Georgia')\n\n\nstates <- setdiff(unique(USA$state),c('Guam','District of Columbia'))\nny <- NULL\nsw <- NULL\nfor (st in states){\n  dum <- NY[,c('deaths_pc','growth_rate')]\n  dum[,state:=st]\n  ny <- rbind(ny,dum)\n  \n  dum <- SWE[,c('deaths_pc','growth_rate')]\n  dum[,state:=st]\n  sw <- rbind(sw,dum)\n}\n\nUSA[state %in% states] %>%\nggplot(aes(deaths_pc,growth_rate))+\n  geom_line(data=ny,aes(color='black'),color='black',lwd=1.2)+\n  geom_line(data=sw,aes(color='black'),color=swy,lwd=1.2)+\n  geom_line(col='steelblue',lwd=1.2)+\n  scale_x_continuous(trans='log',limits=c(1e-5,3e-3),breaks=10^(-5:0))+\n  scale_y_continuous(limits=c(-0.1,0.4))+\n  theme_bw()+\n  geom_hline(yintercept = 0)+\n  facet_wrap(.~state)\n  \nggsave('figures/all_states.png',height=10,width=15,units='in')",
    "created" : 1598476325708.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "411273818",
    "id" : "7B011D29",
    "lastKnownWriteTime" : 1598480821,
    "last_content_update" : 1598480821327,
    "path" : "~/COVID/deaths_vs_growth_rate/scripts/state_interventions.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}