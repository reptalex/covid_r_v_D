{
    "collab_server" : "",
    "contents" : "rm(list=ls())\ngc()\nlibrary(magrittr)\nlibrary(ggpubr)\nlibrary(data.table)\nlibrary(COVID19)\nlibrary(zoo)\nlibrary(gganimate)\nwindow_size=21\n# growth_rate vs. cumulative incidence ------------------------------------------------------------------------\ngetGrowthRate <- function(n,new_confirmed,date,day_of_week,z_score=FALSE){\n  dd <- data.table('new_confirmed'=new_confirmed,\n                   'date'=date,\n                   'day_of_week'=day_of_week)\n  \n  fit <- glm(new_confirmed~date+day_of_week,family=poisson,data=dd[n])\n  # fit <- mgcv::gam(new_confirmed~date+day_of_week,family='nb',data=dd[n])\n  if (z_score){\n    if (!'gam' %in% class(fit)){\n      \n      summary(fit)$coefficients['date','z value'] %>%\n        return\n    } else {\n      summary(fit)$p.t['date'] %>% return\n    }\n  } else {\n    return(coef(fit)['date'])\n  }\n}\n\n\n\n# USA ---------------------------------------------------------------------\n\nUSA <- covid19(country='United States',level=2) %>% as.data.table\ncolnames(USA)[colnames(USA)=='administrative_area_level_2'] <- 'state'\nsetkey(USA,state,date)\n\nmax(USA$date)\n\nUSA[,new_confirmed:=c(confirmed[1],diff(confirmed)),by=state]\nUSA[new_confirmed<0,new_confirmed:=0]\nUSA[,cumulative_pc_cases:=confirmed/population]\nUSA[,gr:=(new_confirmed+shift(new_confirmed)+shift(new_confirmed,n=3))/\n      (shift(new_confirmed,7)+shift(new_confirmed,8)+shift(new_confirmed,9)),by=state]\n\nUSA[,day_of_week:=weekdays(date)]\nUSA[,n:=1:.N,by=state]\nUSA[,new_deaths:=c(deaths[1],diff(deaths)),by=state]\nUSA[,growth_rate:=rollapply(n,width=window_size,FUN=getGrowthRate,fill=NA,\n                            new_confirmed=new_confirmed,date=date,\n                            day_of_week=day_of_week,align='right'),\n    by=state]\nUSA[,deaths_pc:=deaths/population]\nx <- USA[,list(growth_rate=growth_rate[max(which(!is.na(growth_rate)))],\n               deaths_pc=deaths_pc[max(which(!is.na(growth_rate)))],\n               date=max(date),\n               id=unique(key_alpha_2)),by=state]\n\nggplot(USA,aes(deaths_pc,growth_rate,by=state,color=date))+\n  geom_line(lwd=2,alpha=0.2)+\n  geom_hline(yintercept = log(2)/7,lty=2)+\n  geom_hline(yintercept=0,lty=1)+\n  geom_point(data=x,cex=2,color='red')+\n  geom_text(data=x,aes(label=id),hjust=-0.3, vjust=-0.3,color='red')+\n  scale_y_continuous('Exponential (Poisson) Growth Rate',limits=c(-0.25,0.5))+\n  theme_bw()+\n  ggtitle(paste('Incidence vs Growth rate as of',max(X$date)))+\n  guides(colour = guide_legend(override.aes = list(size=8)))+\n  theme(legend.position = 'none')+\n  scale_x_continuous('Cumulative deaths per Capita',trans='log',limit=c(1e-7,4e-3),breaks=10^(-8:-1))\n\n# world -------------------------------------------------------------------\nX <- covid19(level=1) %>% as.data.table\ncolnames(X)[colnames(X)=='administrative_area_level_1'] <- 'country'\nsetkey(X,country,date)\n\ncountries_of_interest <- c('United States','Belgium','Italy','Switzerland',\n                           'Sweden','Norway','Netherlands','France','Spain',\n                           'Brazil','India','Iran','Denmark','Finland')\nX <- X[country %in% countries_of_interest]\nX[country=='China',population:=5.85e7] #Assume China's sampling reflected Wuhan epidemic\n\n\nX[,new_confirmed:=c(confirmed[1],diff(confirmed)),by=country]\nX[new_confirmed<0,new_confirmed:=0]\nX[,new_deaths:=c(deaths[1],diff(deaths)),by=country]\nX[,cumulative_pc_cases:=confirmed/population]\nX[,deaths_pc:=deaths/population]\nX[,day_of_week:=weekdays(date)]\nX[,n:=1:.N,by=country]\nwindow_size=21\nX[,growth_rate:=rollapply(n,width=window_size,FUN=getGrowthRate,fill=NA,\n                          new_confirmed=new_confirmed,date=date,\n                          day_of_week=day_of_week,align='right'),\n  by=country]\n\n\n\nst <- USA[state %in% c('New York','New Jersey','Louisiana')]\nst[,country:=state]\nst[,id:=key_alpha_2]\nst[,deaths_pc:=deaths/population]\ncols <- c('date','deaths_pc','growth_rate','country','id')\nX <- rbind(X[,cols,with=F],\n           st[,cols,with=F])\n\n\nx.c <- X[,list(growth_rate=growth_rate[max(which(!is.na(growth_rate)))],\n               deaths_pc=deaths_pc[max(which(!is.na(growth_rate)))],\n               date=max(date),\n               id=unique(id)),by=country]\n\n\n\nxm <- X[,list(growth_rate=max(growth_rate),\n              country='MAX'),by=deaths_pc]\n\nfocal_countries <- c('New York','Louisiana','Sweden','Spain')\ng_world=X %>%\n  ggplot(aes(deaths_pc,growth_rate,by=country))+\n  geom_line(lwd=2,alpha=0.8,color='grey')+\n  # geom_line(data=X[country %in% c('New York','Norway','Sweden','Denmark','Finland')],lwd=2,alpha=0.2)+\n  geom_hline(yintercept = log(2)/7,lty=2)+\n  geom_hline(yintercept=0,lty=1)+\n  geom_line(data=X[country %in% focal_countries],aes(color=country),lwd=2)+\n  geom_point(data=x.c,cex=2,color='red')+\n  geom_text(data=x.c,aes(label=id),hjust=-0.3, vjust=-0.3,color='grey')+\n  geom_text(data=x.c[country %in% focal_countries],aes(color=country,label=id),hjust=-0.3, vjust=-0.3)+\n  scale_y_continuous('Exponential (Poisson) Growth Rate',limits=c(-0.25,0.5))+\n  theme_bw()+\n  ggtitle(paste('Incidence vs Growth rate as of',max(X$date)))+\n  guides(colour = guide_legend(override.aes = list(size=8)))+\n  # theme(legend.position = 'none')+\n  scale_colour_manual(name='Region',\n                      breaks=focal_countries,\n                      labels=focal_countries,\n                      values=viridis::viridis(length(focal_countries)))+\n  theme(legend.position=c(0.8,0.8),\n        legend.background = element_rect(fill=rgb(0.9,0.9,0.9),size=0.5,linetype='solid'))+\n  # geom_line(data=X[country %in% c('New York','Norway','Sweden','Denmark','Finland')],lty=1,col='black')+\n  scale_x_continuous('Cumulative deaths per Capita',trans='log',limit=c(1e-7,4e-3),breaks=10^(-8:-1))\n\ng_world\n\n\n\nX %>% as.data.frame %>%\n  ggplot(aes(deaths_pc,growth_rate,by=country,color=country))+\n  geom_point(alpha=0.5,cex=2)+\n  geom_point(data=as.data.frame(X[country %in% c('United States','New York','China','Sweden')]),cex=6)+\n  scale_y_continuous('Exponential (Poisson) Growth Rate',limits=c(-0.25,0.5))+\n  theme_bw()+\n  geom_hline(yintercept = log(2)/2.6,lty=3)+\n  geom_hline(yintercept = log(2)/7,lty=2)+\n  geom_hline(yintercept = 0)+\n  guides(colour = guide_legend(override.aes = list(size=8)))+\n  theme(legend.position = 'none')+\n  scale_x_continuous('Cumulative deaths per Capita',trans='log',limit=c(1e-7,4e-3),breaks=10^(-8:-1))+\n  transition_time(date)+\n  labs(title = 'Date : {frame_time}')+\n  ease_aes('linear')\n\n\n\n\n\n# counties ---------------------------------------------------------------\n\nY <- covid19(country='United States',level=3) %>% as.data.table\ncolnames(Y)[colnames(Y)=='administrative_area_level_2'] <- 'state'\ncolnames(Y)[colnames(Y)=='administrative_area_level_3'] <- 'county'\nsetkey(Y,state,county,date)\n\nmax(Y$date)\n\nY[,new_confirmed:=c(confirmed[1],diff(confirmed)),by=c('state','county')]\nY[new_confirmed<0,new_confirmed:=0]\nY[,day_of_week:=weekdays(date)]\nY[,n:=1:.N,by=c('state','county')]\nY[,new_deaths:=c(deaths[1],diff(deaths)),by=c('state','county')]\nY[,growth_rate:=rollapply(n,width=window_size,FUN=getGrowthRate,fill=NA,\n                            new_confirmed=new_confirmed,date=date,\n                            day_of_week=day_of_week,align='right'),\n    by=c('state','county')]\nY[,deaths_pc:=deaths/population]\n\n\nY[,scounty:=paste(key_alpha_2,county,sep='_')]\nyy <- Y[,list(growth_rate=growth_rate[max(which(!is.na(growth_rate)))],\n              deaths_pc=deaths_pc[max(which(!is.na(growth_rate)))],\n              date=max(date),\n              id=unique(key_alpha_2)),by=scounty]\n\nggplot(Y,aes(deaths_pc,growth_rate,by=scounty))+\n  geom_line(lwd=2,alpha=0.2)+\n  geom_hline(yintercept = log(2)/7,lty=2)+\n  geom_hline(yintercept=0,lty=1)+\n  geom_point(data=yy,cex=2,color='red')+\n  geom_text(data=yy,aes(label=id),hjust=-0.3, vjust=-0.3,color='red')+\n  scale_y_continuous('Exponential (Poisson) Growth Rate',limits=c(-0.25,0.5))+\n  theme_bw()+\n  ggtitle(paste('Incidence vs Growth rate as of',max(X$date)))+\n  guides(colour = guide_legend(override.aes = list(size=8)))+\n  theme(legend.position = 'none')+\n  scale_x_continuous('Cumulative deaths per Capita',trans='log',limit=c(1e-7,4e-3),breaks=10^(-8:-1))\n\nsave(list=ls(),file='data/all_growth_rates_countries_states_UScounties.Rd')\n",
    "created" : 1598368770684.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1551557876",
    "id" : "A924114F",
    "lastKnownWriteTime" : 1598370459,
    "last_content_update" : 1598370459955,
    "path" : "~/COVID/covid_r_v_D/scripts/r_v_D_across_countries.R",
    "project_path" : "scripts/r_v_D_across_countries.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}